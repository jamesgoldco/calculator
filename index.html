<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exempt Bot - Treasury Tax Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
    <style>
        :root {
            /* Brand colors - luxury tech palette */
            --primary: #4F46E5;
            --primary-dark: #3730A3;
            --primary-light: #EEF2FF;
            --accent: #8B5CF6;
            --accent-dark: #6D28D9;
            --accent-light: #EDE9FE;
            --secondary: #8B5CF6;
            --secondary-dark: #6D28D9;
            --midnight: #111827;
            --deep-blue: #1E40AF;
            
            /* Gradients */
            --primary-gradient: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            --luxe-gradient: linear-gradient(135deg, #4F46E5 0%, #8B5CF6 50%, #EC4899 100%);
            --secondary-gradient: linear-gradient(135deg, #7C3AED 0%, #8B5CF6 100%);
            --subtle-gradient: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(209,213,219,0.1) 100%);
            
            /* UI colors */
            --success: #10B981;
            --success-light: #D1FAE5;
            --error: #EF4444;
            --warning: #6D28D9;
            
            /* Neutrals */
            --gray-50: #F9FAFB;
            --gray-100: #F3F4F6;
            --gray-200: #E5E7EB;
            --gray-300: #D1D5DB;
            --gray-400: #9CA3AF;
            --gray-500: #6B7280;
            --gray-600: #4B5563;
            --gray-700: #374151;
            --gray-800: #1F2937;
            --gray-900: #111827;
            
            /* Elevation & Depth */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.03);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            --shadow-glow: 0 0 15px rgba(79, 70, 229, 0.5);
            --shadow-gold: 0 0 15px rgba(217, 119, 6, 0.2);
            
            /* Border radius */
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --radius-2xl: 2rem;
            --radius-full: 9999px;
            
            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --spacing-3xl: 4rem;
            
            /* Z-index */
            --z-0: 0;
            --z-10: 10;
            --z-20: 20;
            --z-30: 30;
            --z-40: 40;
            --z-50: 50;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background: radial-gradient(circle at 10% 20%, rgba(111, 85, 241, 0.13) 0%, transparent 20%),
                        radial-gradient(circle at 90% 80%, rgba(79, 70, 229, 0.15) 0%, transparent 25%),
                        radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.9) 0%, transparent 100%),
                        var(--gray-50);
            background-attachment: fixed;
            padding: var(--spacing-xl);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%234F46E5' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
            z-index: -1;
            pointer-events: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        header {
            background-image: var(--luxe-gradient);
            color: white;
            padding: var(--spacing-3xl) var(--spacing-2xl);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.5;
            z-index: 0;
        }

        .logo-area {
            position: relative;
            z-index: 1;
        }

        /* Logo */
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-md);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background-image: var(--secondary-gradient);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-sm);
            box-shadow: var(--shadow-md), 0 0 15px rgba(124, 58, 237, 0.3);
            color: white;
            font-weight: 700;
        }

        .logo-text {
            font-weight: 800;
            font-size: 1.5rem;
            background-image: linear-gradient(120deg, #ffffff 0%, #f0f0ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }

        .tagline {
            display: inline-block;
            font-size: 0.875rem;
            font-weight: 500;
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            margin-bottom: var(--spacing-sm);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            font-weight: 800;
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
            background-image: linear-gradient(120deg, #ffffff 0%, #f0f0ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
            line-height: 1.1;
        }

        .subtitle {
            font-weight: 400;
            opacity: 0.9;
            font-size: 1.25rem;
            margin-bottom: var(--spacing-lg);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: var(--spacing-xl);
            margin-top: var(--spacing-xl);
            padding: var(--spacing-md) 0;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .stat-label {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        main {
            padding: var(--spacing-3xl) var(--spacing-2xl);
            background-image: var(--subtle-gradient);
        }

        .section {
            margin-bottom: var(--spacing-2xl);
            animation: fadeIn 0.5s ease-out;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--spacing-xl);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .section:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--gray-200);
            position: relative;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        h2::before {
            content: '';
            display: block;
            width: 4px;
            height: 24px;
            background-image: var(--primary-gradient);
            border-radius: var(--radius-sm);
        }

        h2::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 50px;
            height: 3px;
            background-image: var(--primary-gradient);
            border-radius: 3px;
        }

        label {
            display: block;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        input[type="file"], select, input[type="number"] {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.875rem;
            color: var(--gray-800);
            background-color: white;
            transition: all 0.2s ease;
            margin-bottom: var(--spacing-md);
            box-shadow: var(--shadow-sm);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        button {
            background-image: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: 0.875rem 1.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            margin-bottom: 0.75rem;
            position: relative;
            z-index: 1;
            overflow: hidden;
            box-shadow: var(--shadow);
            letter-spacing: 0.5px;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 50%);
            z-index: -1;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:hover::before {
            transform: translateY(100%);
        }

        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background-image: none;
            background-color: white;
            color: var(--primary);
            border: 1px solid var(--primary-light);
        }

        .btn-secondary:hover {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }

        .btn-danger {
            background-image: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }

        .btn-danger:hover {
            background-image: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%);
        }

        .btn-primary-gradient {
            background-image: var(--luxe-gradient);
            box-shadow: var(--shadow-md);
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .btn-primary-gradient:hover {
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            background-color: white;
        }

        th {
            background-color: var(--gray-100);
            text-align: left;
            padding: 1.25rem 1rem;
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--gray-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--gray-200);
        }

        td {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            font-size: 0.875rem;
            color: var(--gray-800);
        }

        tbody tr {
            transition: all 0.2s ease;
        }

        tbody tr:hover {
            background-color: var(--primary-light);
        }

        .success {
            color: var(--success);
            background-color: var(--success-light);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            margin: 1rem 0;
            display: inline-block;
            font-weight: 500;
        }

        .error {
            color: var(--error);
            background-color: rgba(239, 68, 68, 0.1);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            margin: 1rem 0;
            display: inline-block;
            font-weight: 500;
        }

        .loading {
            color: var(--primary);
            background-color: var(--primary-light);
            padding: 0.75rem 1rem;
            border-radius: var(--radius);
            margin: 1rem 0;
            display: inline-block;
            font-weight: 500;
        }

        /* Subtle icon button */
        .btn-icon {
            background: transparent;
            color: var(--gray-500);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
            margin: 0;
            transition: all 0.2s ease;
            line-height: 1;
            box-shadow: none;
        }

        .btn-icon:hover {
            background-color: var(--gray-100);
            color: var(--error);
            transform: none;
            box-shadow: none;
        }

        /* Tab navigation */
        .tabs {
            display: flex;
            margin-bottom: var(--spacing-lg);
            background-color: var(--gray-100);
            border-radius: var(--radius-full);
            padding: 0.25rem;
            position: relative;
            z-index: 1;
            box-shadow: var(--shadow-inner);
            border: 1px solid var(--gray-200);
        }

        .tab {
            padding: 0.75rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            flex: 1;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            background-color: white;
            box-shadow: var(--shadow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* Improved Processing Status UI */
        .processing-status {
            background-color: white;
            border-radius: var(--radius-lg);
            margin: 1.5rem 0;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
        }

        .processing-header {
            background-image: var(--luxe-gradient);
            color: white;
            padding: 1rem 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .processing-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .processing-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
            box-shadow: 0 0 0 rgba(16, 185, 129, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .processing-content {
            padding: 1.5rem;
            position: relative;
        }

        .processing-message {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .processing-message-text {
            font-size: 1rem;
            color: var(--gray-800);
            font-weight: 500;
        }

        .processing-progress {
            margin-top: 1.25rem;
            height: 8px;
            background-color: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background-image: var(--luxe-gradient);
            border-radius: var(--radius-full);
            position: absolute;
            top: 0;
            left: 0;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .processing-info {
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .processing-step {
            font-weight: 500;
        }

        .processing-time {
            font-variant-numeric: tabular-nums;
        }

        .processing-status.success .processing-header {
            background-image: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        .processing-status.error .processing-header {
            background-image: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
        }

        /* Dividend amount styling */
        .dividend-amount {
            color: var(--success);
            font-weight: 500;
        }

        /* Tax savings styling */
        .tax-savings {
            color: var(--success);
            font-weight: 500;
        }

        /* Animated totals styling */
        .animated-total {
            color: var(--success);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            position: relative;
            display: inline-block;
        }

        /* Animation for counting up numbers */
        @keyframes countUpFade {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* Enhanced fund item highlight animation */
        .fund-item-highlight {
            animation: highlightRow 3s ease-out;
            position: relative;
            transition: all 0.5s ease;
        }

        @keyframes highlightRow {
            0% { background-color: var(--primary-light); transform: translateX(-10px); opacity: 0; }
            10% { transform: translateX(0); opacity: 1; }
            60% { background-color: var(--primary-light); }
            100% { background-color: transparent; }
        }

        /* Smoother success checkmark */
        .success-checkmark {
            color: var(--success);
            margin-left: 8px;
            font-weight: bold;
            display: inline-block;
            transform: scale(0);
            animation: popIn 0.8s forwards 0.3s;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.3); opacity: 1; }
            80% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }

        /* Counter styles */
        .fund-counter {
            background-color: white;
            color: var(--primary-dark);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow);
            border: 1px solid var(--primary-light);
            position: relative;
            overflow: hidden;
        }

        .fund-counter::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-image: var(--luxe-gradient);
        }

        .counter-animation {
            display: inline-block;
            animation: counterPulse 0.5s ease-out;
        }

        @keyframes counterPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .hidden {
            display: none;
        }

        #fundsSection, #results {
            animation: fadeIn 0.5s ease-out;
        }

        /* Results section styling */
        #results {
            background: linear-gradient(180deg, white 0%, var(--primary-light) 100%);
            border: 1px solid var(--primary-light);
            position: relative;
        }

        #results::before {
            content: none; /* Removing the icon */
        }

        /* Pricing section */
        .pricing {
            display: flex;
            justify-content: space-between;
            gap: var(--spacing-md);
            margin-top: var(--spacing-2xl);
        }

        .price-card {
            flex: 1;
            background-color: white;
            border-radius: var(--radius);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .price-card.featured {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        .price-card.featured::before {
            content: 'MOST POPULAR';
            position: absolute;
            top: 12px;
            right: -30px;
            background-color: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 30px;
            transform: rotate(45deg);
            letter-spacing: 1px;
        }

        .price-header {
            padding-bottom: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--gray-200);
        }

        .price-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .price-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: var(--spacing-sm) 0;
        }

        .price-period {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .price-features {
            flex: 1;
            text-align: left;
            padding: 0;
            list-style: none;
            margin-bottom: var(--spacing-lg);
        }

        .price-feature {
            padding: 8px 0;
            font-size: 0.875rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
        }

        .price-feature::before {
            content: '✓';
            margin-right: 8px;
            color: var(--primary);
            font-weight: bold;
        }

        .price-cta {
            margin-top: auto;
            width: 100%;
        }

        /* Footer */
        footer {
            background-color: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            padding: var(--spacing-lg);
            text-align: center;
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .footer-link {
            color: var(--gray-600);
            text-decoration: none;
        }

        .footer-link:hover {
            color: var(--primary);
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            .container {
                border-radius: var(--radius-md);
            }

            header {
                padding: var(--spacing-xl) var(--spacing-md);
            }

            h1 {
                font-size: 2.5rem;
            }

            .stats-bar {
                flex-direction: column;
                gap: var(--spacing-sm);
                padding: var(--spacing-md);
            }

            .stat {
                flex-direction: row;
                justify-content: space-between;
                width: 100%;
            }

            main {
                padding: var(--spacing-lg) var(--spacing-md);
            }

            .section {
                padding: var(--spacing-md);
                margin-bottom: var(--spacing-lg);
            }

            table {
                display: block;
                overflow-x: auto;
            }

            .pricing {
                flex-direction: column;
            }

            .price-card.featured {
                transform: scale(1);
                order: -1;
            }
        }

        /* Animations for glowing and floating CTA */
        @keyframes cta-glow {
            0% { box-shadow: 0 0 5px rgba(79, 70, 229, 0.6), 0 0 10px rgba(79, 70, 229, 0.4); }
            50% { box-shadow: 0 0 15px rgba(79, 70, 229, 0.8), 0 0 20px rgba(79, 70, 229, 0.6); }
            100% { box-shadow: 0 0 5px rgba(79, 70, 229, 0.6), 0 0 10px rgba(79, 70, 229, 0.4); }
        }

        @keyframes cta-float {
            0% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
            100% { transform: translateY(0); }
        }

        .cta-attention {
            animation: cta-glow 2s infinite, cta-float 3s ease-in-out infinite;
            transform-origin: center;
            z-index: 5;
            position: relative;
        }

        /* Animations for tax savings total highlight */
        @keyframes savings-glow {
            0% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.6); text-shadow: 0 0 5px rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 15px rgba(16, 185, 129, 0.8); text-shadow: 0 0 10px rgba(16, 185, 129, 0.8); }
            100% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.6); text-shadow: 0 0 5px rgba(16, 185, 129, 0.6); }
        }

        @keyframes savings-float {
            0% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-3px) scale(1.05); }
            100% { transform: translateY(0) scale(1); }
        }

        .savings-highlight {
            animation: savings-glow 2s infinite, savings-float 3s ease-in-out infinite;
            border-radius: var(--radius);
            padding: 0.25rem 0.5rem;
            position: relative;
            z-index: 2;
            display: inline-block;
            background-color: rgba(16, 185, 129, 0.1);
            font-weight: 700;
            color: var(--success);
        }

        /* Fixed positioning for important information */
        .fixed-highlight {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 100;
            border: 1px solid var(--gray-200);
            display: flex;
            flex-direction: column;
            max-width: 300px;
            font-size: 0.875rem;
            animation: fadeIn 0.5s forwards;
        }

        .fixed-highlight-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .fixed-highlight-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }

        .fixed-highlight-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            color: var(--gray-400);
            padding: 0;
        }

        .fixed-highlight-close:hover {
            color: var(--gray-700);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-area">
                <div class="logo">
                    <div class="logo-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div>
                    <span class="logo-text">Exempt Bot</span>
                </div>
                <div class="tagline">State Tax Relief for Treasury Investments alternatives</div>
                <h1>Treasury Fund State-Tax Benefit Calculator</h1>
                <div class="subtitle">Precisely identify tax-exempt income from your treasury security funds and save thousands in unnecessary state taxes</div>
                
                <div class="stats-bar">
                    <div class="stat">
                        <div class="stat-value">$2.9B+</div>
                        <div class="stat-label">Tax Savings Found</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">98.7%</div>
                        <div class="stat-label">Filing Accuracy</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">$870</div>
                        <div class="stat-label">Avg. Annual Savings</div>
                    </div>
                </div>
            </div>
        </header>
        
        <main>
            <div class="section">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('stateTab', this)">State & Tax Rate</div>
                    <div class="tab" onclick="switchTab('fundsTab', this)">Fund Database</div>
                </div>
                
                <div id="stateTab" class="tab-content active">
                    <label for="state">State of Residence</label>
                    <select id="state" onchange="updateTaxRate()">
                        <option value="AL" data-rate="0.050">Alabama</option>
                        <option value="AZ" data-rate="0.045">Arizona</option>
                        <option value="AR" data-rate="0.055">Arkansas</option>
                        <option value="CA" data-rate="0.093">California</option>
                        <option value="CO" data-rate="0.044">Colorado</option>
                        <option value="CT" data-rate="0.069">Connecticut</option>
                        <option value="DE" data-rate="0.066">Delaware</option>
                        <option value="GA" data-rate="0.055">Georgia</option>
                        <option value="HI" data-rate="0.084">Hawaii</option>
                        <option value="ID" data-rate="0.060">Idaho</option>
                        <option value="IL" data-rate="0.0495">Illinois</option>
                        <option value="IN" data-rate="0.032">Indiana</option>
                        <option value="IA" data-rate="0.085">Iowa</option>
                        <option value="KS" data-rate="0.057">Kansas</option>
                        <option value="KY" data-rate="0.050">Kentucky</option>
                        <option value="LA" data-rate="0.0445">Louisiana</option>
                        <option value="ME" data-rate="0.0715">Maine</option>
                        <option value="MD" data-rate="0.0575">Maryland</option>
                        <option value="MA" data-rate="0.050">Massachusetts</option>
                        <option value="MI" data-rate="0.0425">Michigan</option>
                        <option value="MN" data-rate="0.0985">Minnesota</option>
                        <option value="MS" data-rate="0.050">Mississippi</option>
                        <option value="MO" data-rate="0.053">Missouri</option>
                        <option value="MT" data-rate="0.069">Montana</option>
                        <option value="NE" data-rate="0.0684">Nebraska</option>
                        <option value="NJ" data-rate="0.1075">New Jersey</option>
                        <option value="NM" data-rate="0.059">New Mexico</option>
                        <option value="NY" data-rate="0.109">New York</option>
                        <option value="NC" data-rate="0.0475">North Carolina</option>
                        <option value="ND" data-rate="0.029">North Dakota</option>
                        <option value="OH" data-rate="0.0399">Ohio</option>
                        <option value="OK" data-rate="0.0475">Oklahoma</option>
                        <option value="OR" data-rate="0.099">Oregon</option>
                        <option value="PA" data-rate="0.0307">Pennsylvania</option>
                        <option value="RI" data-rate="0.0599">Rhode Island</option>
                        <option value="SC" data-rate="0.070">South Carolina</option>
                        <option value="UT" data-rate="0.0495">Utah</option>
                        <option value="VT" data-rate="0.0875">Vermont</option>
                        <option value="VA" data-rate="0.0575">Virginia</option>
                        <option value="WV" data-rate="0.065">West Virginia</option>
                        <option value="WI" data-rate="0.0765">Wisconsin</option>
                        <option value="OTHER">Other (Custom Rate)</option>
                    </select>
                    
                    <label for="taxRate">Marginal Tax Rate (%)</label>
                    <input type="number" id="taxRate" value="9.3" min="0" max="100" step="0.1">
                </div>
                
                <div id="fundsTab" class="tab-content">
                    <div class="table-container">
                        <table id="fundDatabaseTable">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>Fund Name</th>
                                    <th>Treasury %</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="fundDatabaseBody">
                                <!-- Will be populated with JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <button onclick="addFundToDatabase()">
                        Add New Fund
                    </button>
                </div>
            </div>

            <div class="section">
                <h2>Upload 1099-DIV PDF</h2>
                <label for="taxPdf">Upload your 1099-DIV PDF</label>
                <input type="file" id="taxPdf" accept=".pdf">
                <button onclick="processPdf()" class="btn-primary-gradient">
                    <span style="display: inline-flex; align-items: center; gap: 6px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Process PDF
                    </span>
                </button>
                <div id="pdfStatus"></div>
                <div id="processingVisual" class="hidden">
                </div>
                <div id="pdfProcessingStatus" class="processing-status hidden">
                    <div class="processing-header">
                        <div class="processing-title">
                            <div class="processing-indicator"></div>
                            <span>Processing PDF</span>
                        </div>
                        <span id="statusTimestamp"></span>
                    </div>
                    <div class="processing-content">
                        <div class="processing-message">
                            <div class="processing-message-text" id="processingText">Starting PDF processing...</div>
                        </div>
                        <div class="processing-progress">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="processing-info">
                            <div class="processing-step" id="processingStep">Step 1/10</div>
                            <div class="processing-time" id="processingTime">0.0 seconds</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section hidden" id="fundsSection">
                <h2>Review Extracted Funds</h2>
                <div id="fundCounter" class="fund-counter hidden">
                    Processing funds: <span id="currentCount">0</span> of <span id="totalCount">0</span>
                    <span id="counterProgress"></span>
                </div>
                <div class="table-container">
                    <table id="fundsTable">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Fund Name</th>
                                <th>Dividend Amount</th>
                                <th>Treasury %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="fundsBody">
                        </tbody>
                    </table>
                </div>
                <button onclick="addFund()">Add Fund Manually</button>
                <button onclick="calculateResults()" class="btn-primary-gradient">
                    <span style="display: inline-flex; align-items: center; gap: 6px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M6 20V10M18 20V4"></path></svg>
                        Calculate Tax Savings
                    </span>
                </button>
            </div>

            <div class="results hidden" id="results">
                <h2>Tax Savings Results</h2>
                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Fund Name</th>
                                <th>Dividend Amount</th>
                                <th>Treasury %</th>
                                <th>Exempt Amount</th>
                                <th>Tax Savings</th>
                            </tr>
                        </thead>
                        <tbody id="resultsBody">
                        </tbody>
                    </table>
                </div>
                <button onclick="downloadCsv()">Download Results CSV</button>
            </div>
            
            <div class="section">
                <h2>Premium Plans</h2>
                <div class="pricing">
                    <div class="price-card">
                        <div class="price-header">
                            <div class="price-name">Free</div>
                            <div class="price-amount">$0</div>
                            <div class="price-period">forever</div>
                        </div>
                        <ul class="price-features">
                            <li class="price-feature">Basic PDF processing</li>
                            <li class="price-feature">Manual fund entry</li>
                            <li class="price-feature">State-specific calculations</li>
                            <li class="price-feature">CSV export</li>
                        </ul>
                        <button class="btn-secondary price-cta">Current Plan</button>
                    </div>
                    
                    <div class="price-card featured">
                        <div class="price-header">
                            <div class="price-name">Pro</div>
                            <div class="price-amount">$19</div>
                            <div class="price-period">per month</div>
                        </div>
                        <ul class="price-features">
                            <li class="price-feature">Advanced PDF processing</li>
                            <li class="price-feature">Bulk uploads</li>
                            <li class="price-feature">Enhanced fund database</li>
                            <li class="price-feature">Year-to-year tracking</li>
                            <li class="price-feature">Tax planning tools</li>
                            <li class="price-feature">Priority support</li>
                        </ul>
                        <button class="btn-primary-gradient price-cta">Upgrade Now</button>
                    </div>
                    
                    <div class="price-card">
                        <div class="price-header">
                            <div class="price-name">Enterprise</div>
                            <div class="price-amount">Contact Us</div>
                            <div class="price-period">custom pricing</div>
                        </div>
                        <ul class="price-features">
                            <li class="price-feature">Everything in Pro</li>
                            <li class="price-feature">API access</li>
                            <li class="price-feature">Custom integrations</li>
                            <li class="price-feature">Dedicated account manager</li>
                            <li class="price-feature">White-labeling options</li>
                            <li class="price-feature">Volume discounts</li>
                        </ul>
                        <button class="btn-secondary price-cta">Contact Sales</button>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="footer-links">
                <a href="#" class="footer-link">Terms</a>
                <a href="#" class="footer-link">Privacy</a>
                <a href="#" class="footer-link">Security</a>
                <a href="#" class="footer-link">Contact</a>
            </div>
            <div>© 2023 Exempt Bot. All rights reserved. Trusted by financial professionals worldwide.</div>
        </footer>
    </div>

    <script>
        // Set worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Tab switching function
        function switchTab(tabId, tabElement) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Show the selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Update tab styling
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
        }

        // Default fund database
        let fundDatabase = {
            'SPAXX': { name: 'Fidelity Government Money Market', treasuryPct: 0.995 },
            'VMFXX': { name: 'Vanguard Federal Money Market', treasuryPct: 0.98 },
            'SGOV': { name: 'iShares 0-3 Month Treasury Bond ETF', treasuryPct: 1.0 },
            'SHV': { name: 'iShares Short Treasury Bond ETF', treasuryPct: 1.0 },
            'BIL': { name: 'SPDR 1-3 Month T-Bill ETF', treasuryPct: 1.0 },
            'TLT': { name: 'iShares 20+ Year Treasury Bond ETF', treasuryPct: 1.0 },
            'IEF': { name: 'iShares 7-10 Year Treasury Bond ETF', treasuryPct: 1.0 },
            'JNK': { name: 'SPDR High Yield Bond ETF', treasuryPct: 0.0 },
            'BND': { name: 'Vanguard Total Bond Market ETF', treasuryPct: 0.41 },
            'AGG': { name: 'iShares Core US Aggregate Bond ETF', treasuryPct: 0.42 }
        };

        let funds = [];
        let results = [];

        // Display the fund database table when page loads
        document.addEventListener('DOMContentLoaded', function() {
            displayFundDatabase();
            updateTaxRate(); // Set initial tax rate based on default state
        });

        // Display fund database in table
        function displayFundDatabase() {
            const tbody = document.getElementById('fundDatabaseBody');
            tbody.innerHTML = '';
            
            Object.entries(fundDatabase).forEach(([ticker, data], index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${ticker}</td>
                    <td>${data.name}</td>
                    <td>${(data.treasuryPct * 100).toFixed(1)}%</td>
                    <td>
                        <button class="btn-icon" onclick="removeFundFromDatabase('${ticker}')" title="Remove fund">
                            ×
                        </button>
                    </td>
                `;
            });
        }

        // Add a new fund to the database
        function addFundToDatabase() {
            const ticker = prompt('Enter ticker symbol:');
            if (!ticker) return;
            
            const name = prompt('Enter fund name:');
            if (!name) return;
            
            const treasuryPct = prompt('Enter treasury percentage (0-100):');
            if (!treasuryPct) return;
            
            const pct = parseFloat(treasuryPct) / 100;
            if (isNaN(pct) || pct < 0 || pct > 1) {
                alert('Please enter a valid percentage between 0 and 100');
                return;
            }
            
            fundDatabase[ticker.toUpperCase()] = {
                name: name,
                treasuryPct: pct
            };
            
            displayFundDatabase();
        }

        // Remove a fund from the database
        function removeFundFromDatabase(ticker) {
            if (confirm(`Are you sure you want to remove ${ticker}?`)) {
                delete fundDatabase[ticker];
                displayFundDatabase();
            }
        }

        // Process PDF with actual text extraction
        async function processPdf() {
            const fileInput = document.getElementById('taxPdf');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a PDF file first');
                return;
            }
            
            const statusDiv = document.getElementById('pdfStatus');
            const processingStatus = document.getElementById('pdfProcessingStatus');
            const processingText = document.getElementById('processingText');
            const progressBar = document.getElementById('progressBar');
            const processingStep = document.getElementById('processingStep');
            const processingTime = document.getElementById('processingTime');
            const statusTimestamp = document.getElementById('statusTimestamp');
            
            // Set timestamp
            const now = new Date();
            statusTimestamp.textContent = now.toLocaleTimeString();
            
            // Reset processing UI state
            processingStatus.classList.remove('success', 'error');
            processingStatus.classList.remove('hidden');
            progressBar.style.width = '0%';
            processingTime.textContent = '0.0 seconds';
            
            // Show processing status
            statusDiv.innerHTML = '<div class="loading">Processing PDF...</div>';
            
            // Clear previous funds
            funds = [];
            document.getElementById('fundsBody').innerHTML = '';
            
            // Hide counter initially
            const fundCounter = document.getElementById('fundCounter');
            fundCounter.classList.add('hidden');
            
            // Start timer
            const startTime = new Date();
            const timer = setInterval(() => {
                const elapsedTime = (new Date() - startTime) / 1000;
                processingTime.textContent = elapsedTime.toFixed(1) + ' seconds';
            }, 100);
            
            // Define processing messages for cycling
            const processingMessages = [
                "Starting PDF processing...",
                "Initializing document scanner...",
                "Reading PDF structure...",
                "Extracting text content...",
                "Analyzing page data...",
                "Searching for fund information...",
                "Matching tickers with database...",
                "Looking for dividend amounts...",
                "Validating extracted data...",
                "Finalizing results..."
            ];
            
            // Create a simulation of processing with messages cycling through
            const messageInterval = Math.floor(4000 / processingMessages.length); // Spread over ~4 seconds
            const messagePromise = new Promise(resolve => {
                let messageIndex = 0;
                let currentProgress = 0;
                
                // Progress updater - updates every 40ms to create 100 steps over 4 seconds
                const progressInterval = setInterval(() => {
                    currentProgress += 1;
                    if (currentProgress <= 100) {
                        progressBar.style.width = `${currentProgress}%`;
                    } else {
                        clearInterval(progressInterval);
                    }
                }, 40); // 4000ms / 100 steps = 40ms per step
                
                const interval = setInterval(() => {
                    processingText.textContent = processingMessages[messageIndex];
                    processingStep.textContent = `Step ${messageIndex + 1}/${processingMessages.length}`;
                    
                    messageIndex++;
                    if (messageIndex >= processingMessages.length) {
                        clearInterval(interval);
                        resolve();
                    }
                }, messageInterval);
            });
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                let fullText = '';
                
                // Extract text from all pages
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                // Find all tickers and their associated dividend amounts
                const lines = fullText.split('\n');
                const tickerPattern = /\b([A-Z]{2,5})\b/g;
                const amountPattern = /\$?([\d,]+\.\d{2})/g;
                const foundData = [];
                
                // Look for patterns indicating dividend information
                lines.forEach((line, index) => {
                    // Look for tickers in the database
                    const tickerMatches = line.match(tickerPattern);
                    if (tickerMatches) {
                        tickerMatches.forEach(ticker => {
                            if (fundDatabase[ticker]) {
                                // Look for dividend amounts in the same line or nearby lines
                                let foundAmount = null;
                                
                                // Check current line for amounts
                                const amountMatches = line.match(amountPattern);
                                if (amountMatches) {
                                    foundAmount = parseFloat(amountMatches[0].replace(/[$,]/g, ''));
                                }
                                
                                // If no amount found, check next few lines
                                if (!foundAmount) {
                                    for (let i = 1; i <= 5 && index + i < lines.length; i++) {
                                        const nextLine = lines[index + i];
                                        const nextAmounts = nextLine.match(amountPattern);
                                        if (nextAmounts) {
                                            foundAmount = parseFloat(nextAmounts[0].replace(/[$,]/g, ''));
                                            break;
                                        }
                                    }
                                }
                                
                                if (foundAmount) {
                                    // Check if this combination already exists
                                    const exists = foundData.some(item => 
                                        item.ticker === ticker && Math.abs(item.dividendAmount - foundAmount) < 0.01
                                    );
                                    
                                    if (!exists) {
                                        foundData.push({
                                            ticker: ticker,
                                            dividendAmount: foundAmount,
                                            fundData: fundDatabase[ticker]
                                        });
                                    }
                                }
                            }
                        });
                    }
                });
                
                // Wait for the message cycling to complete
                await messagePromise;
                
                // Stop the timer
                clearInterval(timer);
                
                // Show success message
                processingStatus.classList.add('success');
                processingText.textContent = `Processing complete! Found ${foundData.length} funds.`;
                progressBar.style.width = '100%';
                
                if (foundData.length > 0) {
                    document.getElementById('fundsSection').style.display = 'block';
                    statusDiv.innerHTML = '<div class="success">PDF processed successfully. Found ' + foundData.length + ' funds with dividend data.</div>';
                    
                    // Initialize the counter
                    document.getElementById('totalCount').textContent = foundData.length;
                    document.getElementById('currentCount').textContent = '0';
                    document.getElementById('counterProgress').textContent = '';
                    fundCounter.classList.remove('hidden');
                    
                    // Show funds one by one with animation
                    addFundsWithAnimation(foundData);
                } else {
                    statusDiv.innerHTML = '<div class="error">No matching funds found in the PDF. Please check the file or add funds manually.</div>';
                }
                
            } catch (error) {
                console.error('Error processing PDF:', error);
                
                // Stop the timer
                clearInterval(timer);
                
                // Show error state
                processingStatus.classList.add('error');
                processingText.textContent = `Error: ${error.message}`;
                
                statusDiv.innerHTML = '<div class="error">Error processing PDF: ' + error.message + '</div>';
            }
        }

        // Add funds one by one with animation
        async function addFundsWithAnimation(foundData) {
            // Show the funds section
            document.getElementById('fundsSection').style.display = 'block';
            const currentCount = document.getElementById('currentCount');
            const counterProgress = document.getElementById('counterProgress');
            
            // Add each fund with a delay
            for (let i = 0; i < foundData.length; i++) {
                const fund = foundData[i];
                
                // Add to global funds array
                funds.push({
                    ticker: fund.ticker,
                    dividendAmount: fund.dividendAmount,
                    fundData: fund.fundData
                });
                
                // Scroll to the table if it's not visible
                if (i === 0) {
                    const fundsTable = document.getElementById('fundsTable');
                    fundsTable.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                // Add to table with highlighting
                addFundToTable(fund);
                
                // Update counter with animation
                currentCount.textContent = i + 1;
                currentCount.classList.add('counter-animation');
                
                // Calculate progress percentage
                const progress = Math.round(((i + 1) / foundData.length) * 100);
                counterProgress.textContent = `${progress}% complete`;
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    currentCount.classList.remove('counter-animation');
                }, 500);
                
                // Wait before adding next fund - longer delay for better visibility
                await new Promise(resolve => setTimeout(resolve, 1200));
            }
            
            // Complete message
            document.getElementById('fundCounter').innerHTML = 
                `<div style="color: var(--success);"><strong>✓ All ${foundData.length} funds processed successfully!</strong></div>`;
                
            // Add attention to Calculate button
            const calculateBtn = document.querySelector('button[onclick="calculateResults()"]');
            calculateBtn.classList.add('cta-attention');
        }

        // Add a single fund to the table with highlight effect
        function addFundToTable(fund) {
            const tbody = document.getElementById('fundsBody');
            const row = tbody.insertRow();
            
            // First make it invisible
            row.style.opacity = '0';
            
            // Set content
            row.innerHTML = `
                <td>${fund.ticker}</td>
                <td>${fund.fundData.name}</td>
                <td><span class="dividend-amount">$${fund.dividendAmount.toFixed(2)}</span></td>
                <td>${(fund.fundData.treasuryPct * 100).toFixed(1)}%</td>
                <td><span class="success-checkmark">✓</span></td>
            `;
            
            // Trigger reflow before applying the animation class
            void row.offsetWidth;
            
            // Add the animation class
            row.classList.add('fund-item-highlight');
            
            // Make sure it's visible (the animation will handle the fade-in)
            row.style.opacity = '';
        }

        // Update funds table (replaced by the one-by-one animation approach)
        function updateFundsTable() {
            const tbody = document.getElementById('fundsBody');
            tbody.innerHTML = '';
            
            funds.forEach((fund, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${fund.ticker}</td>
                    <td>${fund.fundData.name}</td>
                    <td>$${fund.dividendAmount.toFixed(2)}</td>
                    <td>${(fund.fundData.treasuryPct * 100).toFixed(1)}%</td>
                `;
            });
        }

        // Add fund manually
        function addFund() {
            const ticker = prompt('Enter ticker symbol:');
            if (ticker) {
                const dividendAmount = parseFloat(prompt('Enter dividend amount (Box 1a):')) || 0;
                const fund = {
                    ticker: ticker.toUpperCase(),
                    dividendAmount: dividendAmount,
                    fundData: fundDatabase[ticker.toUpperCase()] || { name: 'Unknown Fund', treasuryPct: 0 }
                };
                
                funds.push(fund);
                addFundToTable(fund);
                
                // Flash counter if visible
                const fundCounter = document.getElementById('fundCounter');
                if (!fundCounter.classList.contains('hidden')) {
                    const total = parseInt(document.getElementById('totalCount').textContent);
                    document.getElementById('totalCount').textContent = total + 1;
                    document.getElementById('currentCount').textContent = funds.length;
                    document.getElementById('currentCount').classList.add('counter-animation');
                    
                    setTimeout(() => {
                        document.getElementById('currentCount').classList.remove('counter-animation');
                    }, 500);
                }
                
                // Add attention to Calculate button if we have funds
                if (funds.length > 0) {
                    const calculateBtn = document.querySelector('button[onclick="calculateResults()"]');
                    calculateBtn.classList.add('cta-attention');
                }
            }
        }

        // Update tax rate when state changes
        function updateTaxRate() {
            const select = document.getElementById('state');
            const option = select.options[select.selectedIndex];
            const rate = parseFloat(option.getAttribute('data-rate')) * 100;
            document.getElementById('taxRate').value = rate.toFixed(2);
        }

        // Calculate results
        function calculateResults() {
            const taxRate = parseFloat(document.getElementById('taxRate').value) / 100;
            const state = document.getElementById('state').value;
            results = [];
            
            // Remove attention from calculate button
            const calculateBtn = document.querySelector('button[onclick="calculateResults()"]');
            calculateBtn.classList.remove('cta-attention');
            
            funds.forEach((fund) => {
                // Apply 50% threshold rule for specific states
                let effectiveTreasuryPct = fund.fundData.treasuryPct;
                if (['CA', 'NY', 'CT'].includes(state) && effectiveTreasuryPct < 0.5) {
                    effectiveTreasuryPct = 0; // No exemption if below 50%
                }
                
                const exemptAmount = fund.dividendAmount * effectiveTreasuryPct;
                const taxSavings = exemptAmount * taxRate; // Tax saved on exempt portion
                
                results.push({
                    ticker: fund.ticker,
                    name: fund.fundData.name,
                    dividendAmount: fund.dividendAmount,
                    treasuryPct: effectiveTreasuryPct,
                    exemptAmount: exemptAmount,
                    taxSavings: taxSavings
                });
            });
            
            updateResultsTable();
            document.getElementById('results').style.display = 'block';
        }

        // Update results table
        function updateResultsTable() {
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            
            let totalDividends = 0;
            let totalExemptAmount = 0;
            let totalTaxSavings = 0;
            
            results.forEach(result => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${result.ticker}</td>
                    <td>${result.name}</td>
                    <td><span class="dividend-amount">$${result.dividendAmount.toFixed(2)}</span></td>
                    <td>${(result.treasuryPct * 100).toFixed(1)}%</td>
                    <td>$${result.exemptAmount.toFixed(2)}</td>
                    <td><span class="tax-savings">$${result.taxSavings.toFixed(2)}</span></td>
                `;
                
                totalDividends += result.dividendAmount;
                totalExemptAmount += result.exemptAmount;
                totalTaxSavings += result.taxSavings;
            });
            
            // Add totals row
            const totalRow = tbody.insertRow();
            totalRow.style.fontWeight = 'bold';
            totalRow.style.backgroundColor = '#f8f9fa';
            totalRow.innerHTML = `
                <td colspan="2">TOTALS</td>
                <td><span class="animated-total" data-value="${totalDividends.toFixed(2)}">$0.00</span></td>
                <td></td>
                <td><span class="animated-total" data-value="${totalExemptAmount.toFixed(2)}">$0.00</span></td>
                <td><span class="animated-total savings-total" data-value="${totalTaxSavings.toFixed(2)}">$0.00</span></td>
            `;
            
            // Get all animated totals
            const animatedTotals = totalRow.querySelectorAll('.animated-total');
            
            // Animate the totals with slight delays between each
            setTimeout(() => {
                animateCountUp(animatedTotals[0], totalDividends);
                
                setTimeout(() => {
                    animateCountUp(animatedTotals[1], totalExemptAmount);
                    
                    setTimeout(() => {
                        animateCountUp(animatedTotals[2], totalTaxSavings);
                        
                        // Add highlight and fixed notification for tax savings after animation
                        setTimeout(() => {
                            // Add highlight class to the savings total
                            document.querySelector('.savings-total').classList.add('savings-highlight');
                            
                            // Show fixed notification for total savings
                            const fixedHighlight = document.createElement('div');
                            fixedHighlight.className = 'fixed-highlight';
                            fixedHighlight.innerHTML = `
                                <button class="fixed-highlight-close" onclick="this.parentElement.remove()">×</button>
                                <div class="fixed-highlight-title">Your total tax savings</div>
                                <div class="fixed-highlight-value">$${totalTaxSavings.toFixed(2)}</div>
                                <div>Based on your state tax rate and fund holdings</div>
                            `;
                            document.body.appendChild(fixedHighlight);
                            
                            // Scroll to results if not visible
                            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 1000);
                    }, 400);
                }, 400);
            }, 200);
        }
        
        // Function to animate counting up to a target number
        function animateCountUp(element, targetValue) {
            // Start from 0
            let currentValue = 0;
            const duration = 1500; // ms
            const framesPerSecond = 30;
            const totalFrames = duration / 1000 * framesPerSecond;
            const increment = targetValue / totalFrames;
            let frame = 0;
            
            // Create animation function
            const counter = setInterval(() => {
                frame++;
                currentValue += increment;
                
                // Ensure we don't exceed the target
                if (currentValue > targetValue || frame >= totalFrames) {
                    clearInterval(counter);
                    currentValue = targetValue;
                }
                
                // Update the display value
                element.textContent = '$' + currentValue.toFixed(2);
                
                // Add a fade animation for each update
                element.style.animation = 'none';
                void element.offsetWidth; // Trigger reflow
                element.style.animation = 'countUpFade 0.2s';
                
                // When we reach the target, ensure exact value is shown
                if (currentValue === targetValue) {
                    element.style.animation = '';
                }
            }, 1000 / framesPerSecond);
        }

        // Download results as CSV
        function downloadCsv() {
            let csv = 'Ticker,Fund Name,Dividend Amount,Treasury %,Exempt Amount,Tax Savings\n';
            
            results.forEach(result => {
                csv += `${result.ticker},${result.name},$${result.dividendAmount.toFixed(2)},${(result.treasuryPct * 100).toFixed(1)}%,$${result.exemptAmount.toFixed(2)},$${result.taxSavings.toFixed(2)}\n`;
            });
            
            // Add totals row
            let totalDividends = results.reduce((sum, r) => sum + r.dividendAmount, 0);
            let totalExemptAmount = results.reduce((sum, r) => sum + r.exemptAmount, 0);
            let totalTaxSavings = results.reduce((sum, r) => sum + r.taxSavings, 0);
            
            csv += `TOTALS,,$${totalDividends.toFixed(2)},,$${totalExemptAmount.toFixed(2)},$${totalTaxSavings.toFixed(2)}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'treasury_tax_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html> 
